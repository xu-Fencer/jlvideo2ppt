# 使用指南

本指南将详细介绍如何使用 JL Video to PPT Converter 将视频演示文稿转换为幻灯片。

## 快速开始

### 1. 启动应用

```bash
# 启动图形界面
python main.py

# 或指定端口
python main.py --gui --server-port 8080
```

启动后，打开浏览器访问 `http://localhost:7930`

### 2. 通过命令行处理视频

```bash
# 基本用法
python main.py presentation.mp4

# 指定输出目录
python main.py presentation.mp4 --output ./slides_output

# 使用高质量预设
python main.py presentation.mp4 --preset high_quality

# 快速处理（较低质量但更快）
python main.py presentation.mp4 --preset fast

# 设置时间范围（检测视频的一部分）
python main.py presentation.mp4 --start-time 1:30:00 --end-time 5:00:00

# 处理在线视频URL
python main.py "http://example.com/presentation.mp4"

# 查看帮助
python main.py --help
```

## 详细使用流程

### 步骤 1: 解析视频

在第一个标签页"解析视频"中：

1. **上传视频文件**

   - 点击文件上传区域，选择您的视频文件
   - 支持格式：MP4、AVI、MOV、MKV、WMV、FLV、WebM
   - 或直接在文本框中输入视频路径
   - **支持在线视频URL**：直接输入HTTP/HTTPS地址（如 `http://example.com/video.mp4`）
2. **配置参数**

   - **输出目录**：默认为视频文件所在目录的 `OUTPUT` 子目录
   - **预设**：选择预配置的参数组合
     - `default`: 默认设置，平衡质量和速度
     - `high_quality`: 高质量设置，更精确的检测
     - `fast`: 快速处理，较低的质量要求
   - **时间范围（可选）**：展开"检测范围"设置
     - **起始时间**：检测开始时间（格式：SS、MM:SS 或 HH:MM:SS）
     - **终止时间**：检测结束时间（格式同上）
     - 点击"清除时间范围"按钮可快速清空
3. **开始解析**

   - 点击"开始解析"按钮
   - 系统将：
     - 自动创建时间戳目录（如：`video_20241221_143022`）
     - 分析视频元信息（分辨率、时长、帧率）
     - 使用帧定位直接跳转到检测位置（高性能）
     - 逐帧分析检测幻灯片变化（保留第一帧）
     - 生成缩略图和原始高清图片（用于OCR）
     - 显示解析进度和日志
4. **查看结果**

   - 解析完成后显示视频信息
   - 查看检测到的幻灯片数量
   - OCR识别将自动使用高清原图（显著提升准确率）

### 步骤 2: 筛选幻灯片

在第二个标签页"筛选幻灯片"中：

1. **浏览缩略图**

   - 全宽Gallery显示所有检测到的幻灯片
   - 每个缩略图显示：
     - 幻灯片编号
     - 时间戳
     - 页码（如果已识别）
     - 选择状态
2. **选择操作**

   - **全选**：选择所有幻灯片
   - **取消全选**：取消所有选择
   - **反选**：反转当前选择状态
3. **查看统计**

   - 实时显示已选择数量：
     - 例如：`已选择: 5/10 张幻灯片`
4. **手动选择**

   - 点击缩略图可切换选择状态
   - 选中的幻灯片高亮显示
5. **发送功能**

   - **发送到导出**：将当前选择的幻灯片发送到导出页面
   - **发送到页码识别**：将当前选择的幻灯片发送到OCR页面
   - **清除导出选择**：清除已发送到导出的选择

### 步骤 3: 页码识别（可选）

在第三个标签页"页码识别"中：

1. **配置OCR引擎**（顶部区域）

   - **Tesseract路径**：指定tesseract可执行文件路径（Windows默认：`d:\Program Files\Tesseract-OCR\tesseract.exe`）
   - **OCR引擎**：选择 `pytesseract` 或 `easyocr`
2. **ROI预览和可视化**（上半部分）

   - 上传一张幻灯片图片到"ROI预览"区域
   - 右侧自动显示"预览信息"（像素坐标和百分比）
   - 下方显示"ROI区域可视化"，用红色框标注ROI位置
   - 实时更新：当调整ROI参数时，可视化图像自动更新
3. **设置ROI参数**（左下部分，2x2网格）

   - ROI (Region of Interest) 定义页码在幻灯片中的位置
   - 参数以百分比表示：
     - **X (%)**: 页码区域左上角X坐标（0-100）
     - **Y (%)**: 页码区域左上角Y坐标（0-100）
     - **宽度 (%)**: 页码区域宽度（0-100）
     - **高度 (%)**: 页码区域高度（0-100）
   - 默认值（70%, 70%, 25%, 20%）适用于右下角页码
4. **开始识别**

   - 点击"开始识别"按钮
   - 系统将对每个幻灯片（或从筛选页面发送的幻灯片）执行OCR
   - 提取数字作为页码
   - 自动保存识别的页码到 `pages/` 文件夹：
     - 第一次出现：`slide_页码.jpg`
     - 重复出现：`slide_页码_重复1.jpg`、`slide_页码_重复2.jpg` 等
   - 检测并显示缺页列表（如识别到页码1, 2, 4，则显示页面3缺失）
5. **查看结果**

   - 识别状态显示详细信息：
     - 成功识别的页码数量
     - 发现的重复页码数量
     - 缺失的页码列表
     - 可导出的页面数量
   - 页码将同步到筛选列表
6. **发送到导出**

   - 点击"发送到导出"按钮（仅发送非重复页码）
   - 导出会自动按页码排序（如slide_0001.jpeg, slide_0002.jpeg）

### 步骤 4: 导出幻灯片

在第四个标签页"导出"中：

1. **查看数据来源**

   - "选择来源"显示数据来自哪里：
     - `使用筛选页面选择: x 张幻灯片` - 来自筛选页面
     - `使用页码识别页面选择: x 张幻灯片` - 来自OCR页面
2. **选择导出格式**

   - **PDF**: 导出为 PDF 文件（纯图片，无页码叠加）
   - **JPEG**: 导出为 JPEG 图片
   - **Both**: 同时导出图片和 PDF
3. **配置选项**

   - **命名策略**:
     - `index`: 按幻灯片索引命名（slide_0001.jpeg）
     - `page`: 按页码命名（slide_0001.jpeg）
     - `timestamp`: 按时间戳命名（slide_5.50s.jpeg）
   - **智能命名**: 自动检测页码并使用页码命名（即使选择index策略）
4. **开始导出**

   - 点击"开始导出"按钮
   - 系统将：
     - 根据选择导出幻灯片
     - 自动应用页码命名（如果识别了页码）
     - 生成输出文件到时间戳目录
     - PDF页面大小匹配图片尺寸
     - 显示导出摘要
5. **查看结果**

   - 导出状态显示详细信息
   - 列出所有生成的文件路径
   - 显示输出目录位置（时间戳目录）

## 预设系统

### 内置预设

1. **default（默认）**

   - 帧差阈值：30
   - 最小稳定帧数：3
   - 最小持续时间：2秒
   - 缩略图大小：800px
   - 适用于大多数情况
2. **high_quality（高质量）**

   - 较低的帧差阈值（25）
   - 更多的稳定帧数（5）
   - 更长的最小持续时间（3秒）
   - 更大的缩略图（1200px）
   - 适用于需要精确检测的场景
3. **fast（快速）**

   - 较高的帧差阈值（40）
   - 更少的稳定帧数（2）
   - 更短的最小持续时间（1秒）
   - 较小的缩略图（600px）
   - 适用于快速预览

### 创建自定义预设

```python
from src.presets import Preset, DetectionParams, ThumbnailParams

# 创建自定义预设
custom_preset = Preset(
    name="my_preset",
    description="我的自定义预设",
    detection=DetectionParams(
        frame_diff_threshold=35.0,
        min_stable_frames=4,
        min_duration_sec=2.5
    ),
    thumbnail=ThumbnailParams(
        max_size=1000,
        quality=90
    )
)

# 保存预设
from src.presets import PresetManager
manager = PresetManager("OUTPUT/presets")
manager.save_preset(custom_preset)
```

## 高级用法

### 批量处理

```bash
# 创建批处理脚本 process_videos.sh
#!/bin/bash
for video in *.mp4; do
    echo "Processing: $video"
    python main.py "$video" --output "./output/$(basename "$video" .mp4)"
done

# 运行批处理
bash process_videos.sh
```

### 仅导出模式

如果您已经处理过视频并想重新导出：

```bash
python main.py video.mp4 --export-only --output ./new_export
```

### 自定义 ROI 区域

如果您知道页码的具体位置，可以精确设置 ROI：

```python
# 例如，页码在右下角，距右边 10%，距底部 15%，宽度 20%，高度 10%
roi_x = 70.0    # 距离左边 70%
roi_y = 75.0    # 距离顶部 75%
roi_w = 20.0    # 宽度 20%
roi_h = 10.0    # 高度 10%
```

### 调整检测参数

如果默认检测不准确，可以调整：

1. **帧差阈值**：控制检测灵敏度

   - 降低阈值（如 20-25）：检测更多变化
   - 提高阈值（如 40-50）：只检测明显变化
2. **最小稳定帧数**：防止误检测

   - 增加数值（如 5-7）：需要更多连续帧确认变化
   - 减少数值（如 1-2）：更敏感但可能误检测
3. **最小持续时间**：控制幻灯片最短显示时间

   - 增加数值（如 3-5 秒）：过滤快闪画面
   - 减少数值（如 1 秒）：捕获快速切换

## 故障排除

### 问题 1: 视频无法打开

**原因**: 视频格式不支持或文件损坏

**解决方案**:

1. 检查视频格式是否为支持的类型
2. 尝试使用 ffmpeg 转换格式：
   ```bash
   ffmpeg -i input.avi -c:v libx264 output.mp4
   ```
3. 检查视频文件是否完整

### 问题 2: 检测不到幻灯片

**原因**: 检测参数设置不当

**解决方案**:

1. 降低帧差阈值
2. 增加最小稳定帧数
3. 减少最小持续时间
4. 启用 SSIM 或直方图备用检测

### 问题 3: OCR 识别不准确

**原因**: ROI 区域不正确或图像质量差

**解决方案**:

1. **OCR现在使用高清原图**：相比缩略图，识别准确率已大幅提升
2. 调整 ROI 区域确保只包含页码
3. 提高图像对比度
4. 尝试不同的 OCR 引擎
5. 手动编辑页码（如果支持）

### 问题 4: 导出失败

**原因**: 磁盘空间不足或权限问题

**解决方案**:

1. 检查输出目录权限
2. 确保有足够磁盘空间
3. 检查输出目录是否被其他程序占用

### 问题 5: 处理速度慢

**原因**: 视频分辨率过高或参数设置过于严格

**解决方案**:

1. 使用 "fast" 预设
2. 降低目标 FPS
3. 增加最小持续时间
4. 减小缩略图大小

## 性能优化建议

1. **使用适当的预设**:

   - 预览时使用 "fast"
   - 最终导出时使用 "high_quality"
2. **合理设置输出目录**:

   - 使用 SSD 存储临时文件
   - 定期清理 OUTPUT/tmp 和 OUTPUT/thumbs
3. **调整检测参数**:

   - 平衡检测精度和处理速度
   - 避免过度敏感的设置
4. **批量处理**:

   - 夜间运行大量视频
   - 使用脚本自动化流程

## 常见问题解答

**Q: 支持哪些视频格式？**
A: 支持 MP4格式，其他没试过。确保已安装 ffmpeg。也支持 HTTP/HTTPS 在线视频 URL。

**Q: 可以处理多长的视频？**
A: 理论上无限制。

**Q: 如何备份和恢复预设？**
A: 预设存储在 OUTPUT/presets 目录，可以直接复制该目录进行备份。

**Q: 如何将JPEG合并为PDF？**
A: 使用独立的 `merge_jpeg_to_pdf.py` 脚本：`python merge_jpeg_to_pdf.py -i /path/to/images -o output.pdf`

**Q: 如何贡献代码或报告问题？**
A: 请访问项目 GitHub 页面提交 Issue 或 Pull Request。

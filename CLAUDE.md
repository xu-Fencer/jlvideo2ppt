**方案概述**

- Python 管线面向 avc1 MP4：读取本地路径或 Gradio 上传，临时文件统一落在 `视频目录/OUTPUT`（含 `tmp/`、`thumbs/`）。
- 处理流程：视频解码 → 基于帧差的幻灯片检测（支持备用 SSIM/直方图）→ 生成缩略图缓存 → 筛选 tab 供用户勾选保留页 → OCR 页码识别 tab（自定义 ROI）→ 导出为图片、PDF 或两者，并按页码排序（可选）。
- 预设体系涵盖全部可调参数（检测阈值、ROI、导出、UI 偏好），JSON 存储在 `OUTPUT/presets/`，支持保存/加载/设默认。

**核心模块设计**

- `video_io.py`: ffprobe 元信息、帧流迭代（可设抽帧 fps/区间）、上传文件落地、输出目录初始化。
- `slide_detector.py`: 帧差法（灰度→模糊→ `cv2.absdiff`→阈值），去抖+最小持续时间；可启用备用指标。
- `thumbs.py`: 批量生成缩略图（压缩 JPEG），缓存路径写入帧 metadata。
- `selection.py`: 维护当前帧列表与用户勾选状态，提供全选/反选/按页码排序等操作。
- `page_number.py`: ROI 配置解析、OCR（pytesseract/easyocr）、数字正则提取、冲突检测、排序接口。
- `exporter.py`: 依据筛选结果导出图片/PDF（Pillow/ReportLab），保障输出目录、命名、异常复位。
- `presets.py`: JSON schema 验证，兼容旧字段；含 ROI/筛选偏好。
- `pipeline.py`: 串联各模块、写日志、管理 Gradio 状态、暴露 CLI/Gradio 入口。

**参数与预设**

- 检测：抽帧 fps、帧差阈值、最小稳定帧数、最小持续时间、备用算法权重。
- 缩略图：尺寸、压缩质量、缓存策略。
- 筛选 tab：默认全选 or 仅新页；多选行为；页码排序开关。
- 页码识别：ROI（x,y,w,h 百分比）、OCR 引擎、后处理正则、排序优先级。
- 导出：格式（PNG/JPEG/PDF）、PDF 页面尺寸/边距、输出目录。
- 预设：命名、设默认、导入/导出 JSON；缺字段时填默认并提示。

**Gradio 前端流程**

- Tab1（解析）：上传/输入路径→输出目录→参数/预设→点击“解析”显示进度与检测日志。
- Tab2（筛选）：平铺缩略图画廊（可复选/全选/反选/按页码排序），勾选结果写入状态；显示统计。
- Tab3（页码识别）：展示示例图 + ROI 选择（拖拽或输入百分比），运行 OCR 得到页码表格，可手动编辑、批量排序；结果同步到筛选列表。
- Tab4（导出）：选择导出模式、格式、目标目录；支持“仅导出”复用上次解析数据；完成后展示路径和日志摘要。
- 预设下拉 + 保存按钮各 tab 可见，日志面板可折叠。

**扩展与健壮性**

- 日志写 `OUTPUT/logs/run-<ts>.log`，UI 可查看。
- 错误处理：视频编码校验、权限、磁盘空间、OCR 缺库等均提示。
- 大文件性能：按区间处理、批量帧读、缩略图懒生成。
- 测试：模块级单测（检测、预设、OCR），小视频集成测试验证解析→筛选→导出闭环。
- 文档：README 描述依赖安装（ffmpeg、opencv-python、pillow、reportlab、pytesseract）、使用指南、常见问题。

**任务书**

1. **环境与结构**：搭建项目骨架、依赖列表、输出目录规范；编写基础 README。
2. **视频 IO**：实现本地/上传管理、ffprobe 元信息、帧迭代器；含单测。
3. **帧差检测**：完成 `slide_detector.py`（参数化帧差 + 去抖）、日志输出、测试覆盖典型场景。
4. **缩略图模块**：实现缩略图生成/缓存/清理；集成到解析流程。
5. **筛选 tab**：在 Gradio 中构建画廊多选 UI、状态管理、全选/排序操作。
6. **页码识别**：
   - ROI 配置 UI 与状态；
   - OCR 模块 + 数字解析 + 排序写回；
   - 表格展示与手动编辑。
7. **导出器**：支持图片/PDF 导出、命名策略、异常处理；与筛选结果/页码排序联动。
8. **预设扩展**：Schema 更新（含 ROI/筛选参数），保存/加载 UI，兼容旧预设。
9. **集成管线**：`pipeline.py` 串联所有流程，处理状态、日志、错误提示。
10. **测试与示例**：准备样例视频/图片，端到端跑流程，记录并修复问题；完善 README、操作指南、FAQ。

---

Automatically use context7 for code generation and library documentation.
